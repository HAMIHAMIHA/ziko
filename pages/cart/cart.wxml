<wxs module="fixDecimals" src="/utils/fixDecimals.wxs"></wxs>

<view class="container container-grey container-btn-bottom {{ error }}">
  <form bindsubmit="pay">
    <view class="white-box order-products_container">
      <view class="nunito_700 header">{{ _t.items }}</view>
      <block wx:for="{{ products }}" wx:key="id" wx:for-item="product">
        <view class="order-products product_container" wx:if="{{ product.amount }}">
          <view class="flex-between product" mark:type="{{ product.type }}">
            <view class="flex-start flex-align-start product_left">
              <view class="product-image">
                <image src="{{ _setting.folders.pack + product.illustation.uri }}" mode="aspectFill" wx:if="{{ product.type == 'packs' && product.illustation }}"></image>
                <image src="/assets/images/packDefault.png" mode="aspectFill" wx:elif="{{ product.type == 'packs' }}"></image>
                <image src="{{ _setting.folders.product + product.product.mainPicture[_language].uri }}" mode="aspectFill" wx:else></image>
              </view>
              <view class="product-info">
                <view class="info_container">
                  <view class="nunito_700 product-title">{{ product.type == 'packs' ? product.name[_language] : product.product.name[_language] }}</view>
                  <!-- Pack Products Detail -->
                  <view class="product-detail_container" wx:if="{{ product.type == 'packs' }}">{{ product.products_info }}</view>
                  <!-- End of Pack Products Detail -->

                  <!-- Single Products Detail -->
                  <view class="product-detail_container" wx:else>
                    <text>{{ product.product.storageType && product.product.storageType != 'none' ? '(' + _t.storage_types[product.product.storageType] + ') ' : '' }}</text>
                    <text wx:if="{{ product.weight }}">{{ product.quantity ? product.quantity + ' x ' + product.weight + _t.units : product.weight + _t.units }}</text>
                    <text wx:else>{{ product.quantity ? product.quantity > 1 ? product.quantity +  _t.items_unit : product.quantity + _t.item_unit : '' }}</text>
                  </view>
                  <!-- End of Single Products Detail -->

                  <!-- Available Amount Left -->
                  <view class="-font_red product-available">
                    <text wx:if="{{ product.actualStock == 0 }}">{{ _t.products_left.fst + product.actualStock + _t.products_left.snd }}</text>
                    <text wx:elif="{{ product.actualStock >= 100 }}">{{ _t.available.fst + product.actualStock + _t.available.snd }}</text>
                    <text wx:else>{{ _t.only_left.fst + product.actualStock + _t.only_left.snd }}</text>
                  </view>
                  <!-- End of Available Amount Left -->
                </view>
                <!-- Price -->
                <view class="nunito_600 -font_red product-price_container">
                  <text class="product-price" wx:if="{{ product.actualPrice != product.price }}">¥{{ product.actualPrice }}</text>
                  <text class="product-price">¥{{ product.price }}</text>
                </view>
                <!-- End of Price -->
              </view>
            </view>
            <quantity
              class="flex-start product-quantity"
              amount="{{ product.amount }}"
              stock="{{ product.actualStock }}"
              bind:changeAmount="changeAmount"
              data-idx="{{ cart.products[product._id].index_in_offer }}"
              data-price="{{ product.price }}"
            ></quantity>
          </view>
        </view>
      </block>
    </view>

    <view class="white-box details_container">
      <view class="detail" bindtap="toSelectVoucher">
        <text class="detail_label">{{ _t.use_voucher }}</text>
        <view class="nunito_600 detail_result" wx:if="{{ voucher.amount > 0 }}">
          <text class="font_red">-￥{{ voucher.amount }}</text>
          <text class="icon icon-arrow-right"></text>
        </view>
        <view class="nunito_600 detail_result" wx:else>
          <text>{{ _t.available.fst + voucher_count + _t.available.snd }}</text>
          <text class="icon icon-arrow-right"></text>
        </view>
      </view>
      <view class="detail field-2">
        <text class="detail_label">{{ _t.choose_delivery_date }}</text>
        <picker
          class="nunito_600 detail_result"
          name="delivery_date"
          value="{{ delivery_date }}"
          range="{{ delivery_dates }}"
          bindchange="bindPickerChange"
          data-key="delivery_date"
        >
          <view class="flex-center picker">
            <text>{{ delivery_dates[delivery_date] }}</text>
            <text class="icon icon-arrow"></text>
          </view>
        </picker>
      </view>
      <view class="detail">
        <text class="detail_label">{{ _t.delivery_fee }}</text>
        <text class="detail_result">{{ free_delivery || delivery_fee === 0 ? _t.free_delivery : delivery_fee > 0 ? '¥' + delivery_fee : '' }}</text>
      </view>
      <view class="nunito_700 detail">
        <text class="detail_label">{{ _t.total }}</text>
        <text class="detail_result">¥{{ fixDecimals.toFix((_pay_set.finalFee - voucher.amount) * discount) }}</text>
      </view>
    </view>

    <view class="white-box details_container">
      <view class="detail" wx:if="{{ _offer.miniprogram.lotteyEnable }}">
        <text class="detail_label">{{ _t.lottery_tickets }}</text>
        <text class="detail_result">x{{ _pay_set.tickets }}</text>
      </view>
      <!-- Hide for temp -->
      <view class="detail" wx:if="{{ showing }}">
        <text class="detail_label">{{ _t.fidelity_points }}</text>
        <text class="detail_result">+{{ offer.fidelity_points }}30</text>
      </view>
    </view>

    <view class="white-box details_container inputs_container">
      <view class="detail address field-0">
        <text class="detail_label">{{ _t.address }}</text>
        <view class="detail_input input_goto">
          <navigator class="input picker" hover-class="none" url="{{ _routes.address + '?action=select&selected_address=' + address_selected }}">
            <text>{{ _t.address_type[user.addresses[address_selected].type] }}</text>
            <text class="icon icon-arrow-right"></text>
          </navigator>
          <text class="detail_note">{{ user.addresses[address_selected].detailedAddress }}</text>
        </view>
      </view>

      <view class="detail field-1">
        <text class="detail_label">{{ _t.contact_label }}</text>
        <view class="detail_input input_goto">
          <navigator class="input picker" hover-class="none" url="{{ _routes.contacts + '?action=select&selected_contact=' + contact_selected }}">
            <text>{{ user.contacts[contact_selected].name }}</text>
            <text class="icon icon-arrow-right"></text>
          </navigator>
        </view>
      </view>

      <view class="detail">
        <text class="detail_label">{{ _t.phone_no }}</text>
        <view class="detail_input">
          <input
            class="input"
            type="text"
            name="phone"
            value="{{ user.contacts[contact_selected].phone }}"
          />
        </view>
      </view>
    </view>

    <view class="white-box details_container inputs_container">
      <view class="detail checkbox-container fapiao">
        <text class="detail_label">{{ _t.fapiao }}</text>
        <view class="flex-between detail_input">
          <navigator hover-class="none" url="{{ _routes.fapiao + '?action=edit' }}">
            <input class="ellipsis input" type="text" name="fapiao" disabled="true" value="{{ user.fapiaoInformation }}" />
          </navigator>
          <view class="checkbox{{ fapiao ? ' checked' : '' }}" bindtap="toggleCheck" data-key="fapiao">
            <text class="icon icon-check"></text>
          </view>
        </view>
      </view>
    </view>

    <view class="white-box details_container inputs_container">
      <view class="detail">
        <text class="detail_label">{{ _t.comment }}</text>
        <view class="detail_input"><input class="input" name="comment" type="text" /></view>
      </view>
    </view>

    <view class="white-box contact-box">
      <view class="">{{ _t.checkout_message }}</view>
      <view class="contact-button_container">
        <button class="contact-button" open-type="contact">
          <text class="icon icon-headset"></text>
          <text class="nunito_600">{{ _t.contact_customer_hero }}</text>
        </button>
      </view>
    </view>

    <view class="btn-bottom">
      <button class="nunito_600 disabled" wx:if="{{ _pay_set.minimum.items && _pay_set.minimum.items > _pay_set.cart }}">
        {{ _t.minimum + ': ' + _pay_set.minimum.items }}{{ _pay_set.minimum.items < 1 ? _t.item_units : _t.item_unit }}
      </button>
      <button class="nunito_600 disabled" wx:elif="{{ _pay_set.reducedTotal && _pay_set.minimum.price && _pay_set.minimum.price > _pay_set.reducedTotal }}">
        {{ _t.minimum + ': ¥' + _pay_set.minimum.price }}
      </button>
      <button class="nunito_600 disabled" wx:elif="{{ _pay_set.minimum.price && _pay_set.minimum.price > _pay_set.total }}">
        {{ _t.minimum + ': ¥' + _pay_set.minimum.price }}
      </button>
      <button class="nunito_600{{ _pay_set.pay_disabled ? ' disabled' : '' }}" formType="submit" wx:else>
        {{ _t.pay }}
      </button>
    </view>
  </form>
</view>

<lottery-draw id="lottery_modal"></lottery-draw>