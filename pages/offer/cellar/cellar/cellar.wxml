<import src="../../../../templates/offer/products.wxml" />
<import src="../../../../templates/offer/payButton.wxml" />

<view class="container ziko-offer {{ 'community-' + _offer.community }}">
  <!-- Lottery Alert -->
  <!-- TEMP hide for v1 (Did not translate) -->
  <view class="gilroy_700 uppercase flex-center icon_container lottery-alert" wx:if="{{ _setting.nextOffer != '' }}" wx:if="{{ showing }}">
    <view class="icon icon-flash"></view>
    <view class="icon_text">next lottery in 50 items sold</view>
  </view>
  <!-- End of Lottery Alert -->

  <!-- Offer Countdown -->
  <view class="uppercase countdown">
    <view class="nunito_600 countdown_text">{{ _t.remaining_time }}</view>
    <countdown class="gilroy_700 countdown_clock" id="countdown" end-time="{{ _offer.endingDate }}"></countdown>
  </view>
  <!-- End of Offer Countdown -->

  <!-- Contact -->
  <button class="float-contact_container" open-type="contact">
    <view class="icon icon-chat"></view>
  </button>
  <!-- End of Contact -->

  <view class="banner_container">
    <!-- Detail Banner -->
    <view class="banner-image_container swiper_container">
      <swiper class="swiper" bindchange="swiperChange">
        <block wx:for="{{ _offer.media }}" wx:key="key" wx:for-item="media">
          <swiper-item class="swiper_item">
            <image src="{{ media ? media.uri : '' }}" mode="aspectFill" lazy-load="true" ></image>
          </swiper-item>
        </block>
      </swiper>
      <view class="gilroy_700 indicator">
        {{ _setting.swiperIndex }} / {{ _offer.media.length }}
      </view>  
    </view>
    <!-- End of Detail Banner -->

    <!-- Offer Messages -->
    <!-- TEMP hide for v1 -->
    <view class="messages_container" wx:if="{{ showing }}"><scrollMessage></scrollMessage></view>
    <!-- End of Offer Messages -->
  </view>

  <view class="offer-detail_container {{ 'ziko-' + _offer.community }}">
    <!-- Offer Count -->
      <view class="flex-start gilroy_500 offer-count_container">
        <view class="icon_container">
          <view class="icon icon-bag"></view>
          <view class="icon_text">{{ _offer.orders != 1 ? _offer.orders + _t.orders_unit : _offer.orders + _t.order_unit }}</view>
        </view>
        <view class="icon_container">
          <view class="icon icon-eye"></view>
          <view class="icon_text">{{ _offer.views ? _offer.views : 0 }} {{ _t.viewers }}</view>
        </view>
      </view>
    <!-- End of Offer Count -->

    <!-- Share -->
    <button class="share" open-type="share">
      <view class="icon icon-share"></view>
    </button>
    <!-- End of Share -->

    <!-- Offer Detail -->
    <view class="offer-detail">
      <view class="gilroy_700 offer-title">{{ _offer.name[_language] }}</view>
      <view class="gilroy_700 uppercase offer-price-rule" wx:if="{{  _offer.type && _offer.type != 'regular' }}">{{ _t.price_rules[_offer.type] }}</view>
      <view class="offer-description">
        {{ _offer.description[_language] }}
      </view>
    </view>
    <!-- End of Offer Detail -->

    <!-- Offer Cellar Count -->
    <view class="flex-center cellar-total_container" wx:if="{{  _offer.type && _offer.type != 'regular' }}">
      <view class="icon icon-wine"></view>
      <view class="cellar-total">
        <view class="nunito_700 cellar-total_count">{{ _offer.sold }}/{{ _offer.total }}</view>
        <view class="nunito_600 cellar-total_label">{{ _t.total_units_available }}</view>
      </view>
      <view class="cellar-total_progress">
        <view class="cellar-total_progress_fill" style="--progress-fill-: calc(100% * {{ _offer.sold }}/{{ _offer.total }});"></view>
      </view>
    </view>
    <!-- End of Offer Cellar Count -->
  </view>

  <!-- Offer Tabbar -->
  <view class="uppercase gilroy_700 flex-center tabbar">
    <view
      class="tabbar_item{{ _setting.currentTab == 'product' ? ' selected' : '' }}"
      bindtap="switchTab"
      data-to-tab="product"
      animation="{{ _setting.animate.tab }}"
    >
      {{ _t.products }}
    </view>
    <view
      class="tabbar_item{{ _setting.currentTab == 'receipe' ? ' selected' : '' }}"
      bindtap="switchTab"
      data-to-tab="receipe"
      animation="{{ _setting.animate.tab }}"
    >
      {{ _t.receipes }}
    </view>
    <view class="tabbar_highlighter {{ _setting.currentTab }}" animation="{{ _setting.animate.highlight }}"></view>
  </view>
  <!-- End of Offer Tabbar -->


  <!-- Products -->
  <view class="list_container" wx:if="{{ _setting.currentTab == 'product' }}">
    <!-- Offer Product List -->
    <view class="offer-group offer-packs" wx:if="{{ _offer.miniprogram.packs.length > 0 }}" mark:type="packs">
      <view class="uppercase title">
        <text class="gilroy_500">{{ _t.our_selected_packs.fst }}</text>
        <text class="gilroy_700">{{ _t.our_selected_packs.snd }}</text>
      </view>

      <template
        is="products"
        class="product-list"
        data="{{ offer_id: _offer.id, cart: cart, product_list: _offer.miniprogram.packs, _is_pack: true, _community: _offer.community, _t: _t_product, _offer_setting: _offer_setting }}"
      ></template>
    </view>

    <view class="offer-group offer-singles" wx:if="{{ _offer.miniprogram.items.length > 0 }}" mark:type="items">
      <view class="uppercase title">
        <text class="gilroy_500">{{ _t.single_items.fst }}</text>
        <text class="gilroy_700">{{ _t.single_items.snd }}</text>
      </view>

      <template
        is="products"
        class="product-list"
        data="{{ offer_id: _offer.id, cart: cart, product_list: _offer.miniprogram.items, _is_pack: false, _community: _offer.community, _t: _t_product, _offer_setting: _offer_setting }}"
      ></template>
    </view>
    <!-- End of Offer Product List -->

    <!-- Offer Specials -->
    <view class="offer-specials ziko-{{ _offer.community }}" wx:if="{{ _offer.miniprogram.zikoSpecials.length > 0 }}">
      <view class="offer-specials_title">
        <view class="icon icon-ziko-special"></view>
      </view>
      <view class="offer-specials_list">
        <block wx:for="{{ _offer.miniprogram.zikoSpecials }}" wx:key="id" wx:for-item="special">
          <view class="flex-center offer-special" >
            <view class="gilroy_700 uppercase offer-special_title">
              <text wx:if="{{ special.conditionType !== 'item_x_in_cart' }}">{{ _t.offer_special_names[special.conditionType].prefix }}{{ special.conditionValue }}{{ _t.offer_special_names[special.conditionType].suffix }}</text>
              <text wx:else>{{ special.conditionValue != null ? special.conditionValue + ' ' : '' }}{{ _t.offer_special_names[special.conditionType].prefix }}{{ _product_names[special.conditionPack] }}{{ _t.offer_special_names[special.conditionType].suffix }}</text>
            </view>
            <view class="offer-special_detail">
              <text wx:if="{{ special.gift.type == 'pack' }}">{{ _t.offer_special_details.get }}{{ _t.offer_special_details.for_free.prefix }}{{ _product_names[special.gift.pack] }}{{ _t.offer_special_details.for_free.suffix }}</text>
              <text wx:if="{{ special.gift.type == 'add_on' }}">{{ _t.offer_special_details.get }}{{ _t.offer_special_details.for_free.prefix }}{{ _product_names[special.gift.singleItem] }}{{ _t.offer_special_details.for_free.suffix }}</text>
              <text wx:if="{{ special.gift.type == 'voucher' }}">{{ _t.offer_special_details.get }}{{ special.gift.voucherValue }}{{ special.gift.voucherValue === 1 ? _t.offer_special_details.voucher.single : _t.offer_special_details.voucher.multiple }}</text>
              <text wx:if="{{ special.gift.type == 'discount' }}">{{ _t.offer_special_details.get }}{{ special.gift.discountAmount }}{{ _t.offer_special_details.discount }}</text>
              <text wx:if="{{ special.gift.type == 'free_delivery' }}">{{ _t.offer_special_details.get }}{{ _t.offer_special_details.free_delivery }}</text>
              <text wx:if="{{ special.gift.type == 'custom' }}">{{ special.gift.custom[_language] }}</text>
            </view>
          </view>
        </block>
      </view>
    </view>
    <!-- End of Offer Specials -->

    <!-- Lottery -->
    <view class="offer-lotteries" wx:if="{{ _offer.miniprogram.lottery.draws.length > 0 && _offer.miniprogram.lotteryEnable }}">
      <view class="lottery_regular">
        <lottery lottery="{{ _offer.miniprogram.lottery }}" _t="{{ _t_lottery }}"></lottery>

        <view class="offer-lotteries_list">
          <block wx:for="{{ _offer.miniprogram.lottery.draws }}" wx:key="id" wx:for-item="draw">
            <view class="flex-center offer-lottery">
              <view class="gilroy_700 uppercase offer-lottery_title">
                <text wx:if="{{ draw.conditionType === 'number_of_order'}}">{{ draw.conditionValue }} {{ _t.orders }}</text>
                <text wx:else>{{ draw.conditionValue }} {{ _t.offer_special_names.items_sold }}</text>
              </view>

              <view class="offer-lottery_detail">
                <block wx:for="{{ draw.gifts }}" wx:for-item="gift" wx:key="_id">
                  <text wx:if="{{ index > 0 }}"> + </text>
                  <text wx:else>{{ _t.offer_special_details.get }}</text>
                  <text wx:if="{{ gift.type === 'pack' }}">{{ _t.offer_special_details.for_free.prefix }}{{ _product_names[gift.pack] }}{{ _t.offer_special_details.for_free.suffix }}</text>
                  <text wx:if="{{ gift.type === 'add_on' }}">{{ _t.offer_special_details.for_free.prefix }}{{ _product_names[gift.singleItem] }}{{ _t.offer_special_details.for_free.suffix }}</text>
                  <text wx:if="{{ gift.type === 'voucher' }}">{{ gift.voucherValue }}{{ gift.voucherValue === 1 ? _t.offer_special_details.voucher.single : _t.offer_special_details.voucher.multiple }}</text>
                  <text wx:if="{{ gift.type === 'discount' }}">{{ gift.discountAmount }}{{ _t.offer_special_details.discount }}</text>
                  <text wx:if="{{ gift.type === 'custom' }}">{{ gift.custom[_language] }}</text>
                </block>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>
    <!-- End of Lottery -->
  </view>
  <!-- End of Products -->

  <!-- Offer Receipes -->
  <view class="list_container" wx:else>
    <view class="offer-group receipe-group">
      <view class="uppercase title">
        <text class="gilroy_500">{{ _t.related_receipes.fst }}</text>
        <text class="gilroy_700">{{ _t.related_receipes.snd }}</text>
      </view>

      <receipes id="receipes-component"></receipes>
    </view>
  </view>
  <!-- End of Offer Receipes -->

  <!-- Pay Button -->
  <template
    is="payment_container"
    data="{{ _pay_set: _pay_set, _t: _t, user: user, wxUser: wxUser }}"
  ></template>
  <!-- End of Pay Button -->
</view>